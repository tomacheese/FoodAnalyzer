# 任意のレジストリに Docker image を公開orビルドする。
# プルリクの作成・更新時に動作する。

name: Docker

on:
  pull_request:
    branches:
      - main
      - master
    types:
      - opened
      - synchronize
    paths:
      - .github/workflows/docker.yml
  pull_request_target:
    branches:
      - main
      - master
    types:
      - opened
      - synchronize
      - reopened
      - closed
  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.merged == true && github.base_ref || github.event.pull_request.head.sha }}

jobs:
  docker:
    name: Docker CI
    uses: book000/templates/.github/workflows/reusable-docker.yml@master
    with:
      targets: >-
        [
          { imageName: "tomacheese/foodanalyzer", context: ".", file: "Dockerfile", packageName: "foodanalyzer" }
        ]
    secrets:
      DOCKER_USERNAME: ${{ github.actor }}
      DOCKER_PASSWORD: ${{ secrets.GITHUB_TOKEN }}

  build:
    name: Build And Upload Release (${{ matrix.runtime }})
    runs-on: windows-latest
    if: needs.docker.outputs.release_id != ''
    needs: docker

    permissions:
      contents: write

    env:
      version: ${{ needs.docker.outputs.version }}

    strategy:
      fail-fast: false
      matrix:
        runtime:
          [
            win-x86,
            win-x64,
            win-arm64,
            osx-x64,
            osx-arm64,
            linux-x64,
            linux-arm,
            linux-arm64,
          ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Set version from tag
        run: |
          $version = $env:APP_VERSION
          $versionWithRevision = ($version.Split('.') + '0')[0..3] -join '.'
          (Get-Content .\FoodAnalyzer\FoodAnalyzer.csproj) -replace '<Version>[^<]*(</Version>)', "<Version>$version</Version>" | Set-Content .\FoodAnalyzer\FoodAnalyzer.csproj
          (Get-Content .\FoodAnalyzer\FoodAnalyzer.csproj) -replace '<AssemblyVersion>[^<]*</AssemblyVersion>', "<AssemblyVersion>$versionWithRevision</AssemblyVersion>" | Set-Content .\FoodAnalyzer\FoodAnalyzer.csproj
          (Get-Content .\FoodAnalyzer\FoodAnalyzer.csproj) -replace '<FileVersion>[^<]*</FileVersion>', "<FileVersion>$versionWithRevision</FileVersion>" | Set-Content .\FoodAnalyzer\FoodAnalyzer.csproj
        shell: pwsh
        env:
          APP_VERSION: ${{ needs.docker.outputs.version }}

      - name: Restore dotnet packages
        run: dotnet restore FoodAnalyzer.sln

      - name: Build solution
        run: dotnet publish FoodAnalyzer.sln -p:PublishProfile=Publish --runtime ${{ matrix.runtime }}

      - name: Create zip
        run: |
          $zipFilePath = "FoodAnalyzer-${{ matrix.runtime }}.zip"
          $sourceDir = "bin/Publish/*"
          Compress-Archive -Path $sourceDir -DestinationPath $zipFilePath -Force
        shell: pwsh

      - name: Upload file to release
        uses: svenstaro/upload-release-action@v2
        with:
          release_id: ${{ needs.docker.outputs.release_id }}
          file: FoodAnalyzer-${{ matrix.runtime }}.zip
